<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Change Password</title>

    <!-- Bootstrap + Icons + Google Font -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='change_password.css') }}" />
</head>
<body>
    <div class="card">
        <div class="brand">
            <div class="logo">AT</div>
            <div>
                <h1>Change Password</h1>
                <p class="lead">Choose a strong password to keep your account secure</p>
            </div>
        </div>

        <form method="POST" novalidate>
            <div class="mb-3">
                <label for="old_password">Old Password</label>
                <div class="input-group">
                    <input type="password" id="old_password" name="old_password" class="form-control" required aria-required="true" autocomplete="current-password"/>
                    <span class="input-group-text" role="button" tabindex="0" data-toggle="toggle" data-target="#old_password" aria-label="Toggle visibility">
                        <i class="bi bi-eye"></i>
                    </span>
                </div>
            </div>

            <div class="mb-3">
                <label for="new_password">New Password</label>
                <div class="input-group">
                    <input type="password" id="new_password" name="new_password" class="form-control" required aria-required="true" autocomplete="new-password" aria-describedby="passwordHelp"/>
                    <span class="input-group-text" role="button" tabindex="0" data-toggle="toggle" data-target="#new_password" aria-label="Toggle visibility">
                        <i class="bi bi-eye"></i>
                    </span>
                </div>

                <div class="strength" aria-hidden="true" title="Password strength">
                    <i id="strengthBar"></i>
                </div>
                <div class="note" id="passwordHelp">Use at least 8 characters with a mix of letters, numbers & symbols.</div>
            </div>

            <div class="mb-3">
                <label for="confirm_password">Confirm New Password</label>
                <div class="input-group">
                    <input type="password" id="confirm_password" name="confirm_password" class="form-control" required aria-required="true" autocomplete="new-password"/>
                    <span class="input-group-text" role="button" tabindex="0" data-toggle="toggle" data-target="#confirm_password" aria-label="Toggle visibility">
                        <i class="bi bi-eye"></i>
                    </span>
                </div>
                <div class="note" id="matchNote" style="display:none;color:#dc2626;">Passwords do not match</div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Update Password</button>
                <a href="{{ url_for(session.user_type + '_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
            </div>

            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="alert alert-info flash" role="alert">
                        {% for message in messages %}
                            {{ message }}
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
        </form>
    </div>

    <script>
        // Toggle visibility for any .input-group-text toggles
        document.querySelectorAll('[data-toggle="toggle"]').forEach(btn => {
            btn.addEventListener('click', () => {
                const selector = btn.getAttribute('data-target');
                const input = document.querySelector(selector || btn.previousElementSibling);
                if (!input) return;
                const icon = btn.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    if (icon) icon.className = 'bi bi-eye-slash';
                } else {
                    input.type = 'password';
                    if (icon) icon.className = 'bi bi-eye';
                }
            });
            btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }});
        });

        // Password strength meter
        const newPass = document.getElementById('new_password');
        const strengthBar = document.getElementById('strengthBar');
        const confirmPass = document.getElementById('confirm_password');
        const matchNote = document.getElementById('matchNote');

        function scorePassword(p) {
            let score = 0;
            if (!p) return 0;
            // length
            if (p.length >= 8) score += 2;
            if (p.length >= 12) score += 1;
            // variety
            if (/[a-z]/.test(p)) score += 1;
            if (/[A-Z]/.test(p)) score += 1;
            if (/\d/.test(p)) score += 1;
            if (/[^A-Za-z0-9]/.test(p)) score += 2;
            return Math.min(score,7);
        }

        function updateStrength() {
            const val = newPass.value;
            const s = scorePassword(val);
            const percent = Math.round((s / 7) * 100);
            strengthBar.style.width = percent + '%';
            // color stops by manipulating CSS gradient via inline background
            if (percent < 34) strengthBar.style.background = 'linear-gradient(90deg,#ef4444,#f97316)';
            else if (percent < 67) strengthBar.style.background = 'linear-gradient(90deg,#f59e0b,#fbbf24,#10b981)';
            else strengthBar.style.background = 'linear-gradient(90deg,#06b6d4,#10b981,#7c3aed)';
            // update match note too
            checkMatch();
        }

        function checkMatch(){
            const a = newPass.value;
            const b = confirmPass.value;
            if (!b) { matchNote.style.display = 'none'; return; }
            if (a === b) {
                matchNote.style.display = 'none';
            } else {
                matchNote.style.display = 'block';
            }
        }

        newPass.addEventListener('input', updateStrength);
        confirmPass.addEventListener('input', checkMatch);

        // enhance: map toggle attribute selector fallback
        document.querySelectorAll('[data-toggle="toggle"]').forEach(btn => {
            const target = btn.getAttribute('data-target');
            if (target && !target.startsWith('#')) {
                // ensure target is id selector
                btn.setAttribute('data-target', '#' + target);
            }
        });

        // prevent form submit if passwords don't match (client-side)
        document.querySelector('form').addEventListener('submit', function(e){
            if (newPass.value !== confirmPass.value) {
                e.preventDefault();
                matchNote.style.display = 'block';
                matchNote.scrollIntoView({behavior:'smooth', block:'center'});
            }
        });
    </script>
</body>
</html></div>